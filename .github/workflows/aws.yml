name: Aws upload
on:
  push:
    branches: [develop, master]

jobs:
  docker:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v2

      - name: Set up QEMU
        uses: docker/setup-qemu-action@v1

      - id: package-version
        name: 'Getting version from package.json'
        uses: martinbeentjes/npm-get-version-action@master

      - id: docker-tag-master
        name: 'Generating docker tag for master'
        run: echo "docker_tag=${{ steps.package-version.outputs.current-version }}" >> $GITHUB_ENV

      - name: Set up Docker Buildx
        uses: docker/setup-buildx-action@v1

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v1
        with:
          aws-access-key-id: ${{ secrets.AWS_ACCESS_KEY }}
          aws-secret-access-key: ${{ secrets.AWS_SECRET_KEY }}
          aws-region: eu-west-1

      - name: Login to AWS ECR
        id: login-ecr
        uses: aws-actions/amazon-ecr-login@v1

      - name: Build, tag, and push the image to Amazon ECR
        id: build-image
        env:
          NPM_SECRET: ${{ secrets.NPM_AUTH_TOKEN }}
        run: |
          # Build a docker container and push it to ECR
          docker buildx build --platform linux/amd64 -t ${{ secrets.AWS_ECR }}/${{ github.event.repository.name }}:${{ env.docker_tag }} --secret id=npm_auth_token,env=NPM_SECRET --push .

